<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARR Interest Calculator</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      --blue-dark: #0b1e3a;
      --blue: #123765;
      --blue-mid: #1e5bb8;
      --blue-light: #eaf2ff;
      --text-dark: #0a1a33;
      --muted: #5b6b7f;
      --card-border: #d7e3ff;
    }
    body { background: #fff; color: var(--text-dark); }
    .hero {
      background: linear-gradient(90deg, var(--blue-dark), var(--blue));
      color: #fff;
      padding: 24px 0;
      margin-bottom: 20px;
    }
    .brand-badge { position: fixed; top: 10px; right: 12px; background: #fff; border: 1px solid var(--card-border); color: var(--blue); padding: 6px 10px; border-radius: 8px; font-size: 12px; box-shadow: 0 2px 6px rgba(0,0,0,.06); }
    .brand-badge a { color: var(--blue); text-decoration: none; }
    .brand-badge a:hover { text-decoration: underline; }
    .subtitle { color: var(--muted); }
    .calc-card { background: #fff; border: 1px solid var(--card-border); border-radius: 12px; }
    .table-wrap { max-height: 500px; overflow: auto; border: 1px solid var(--card-border); border-radius: 8px; }
    thead th { position: sticky; top: 0; background: var(--blue-light); z-index: 1; }
    /* Darker blue buttons */
    .btn-primary { background-color: var(--blue); border-color: var(--blue); }
    .btn-primary:hover, .btn-primary:focus { background-color: var(--blue-dark); border-color: var(--blue-dark); }
    .btn-outline-primary { color: var(--blue); border-color: var(--blue); }
    .btn-outline-primary:hover, .btn-outline-primary:focus { background-color: var(--blue); border-color: var(--blue); color: #fff; }
  </style>
</head>
<body>
  <div class="brand-badge"><a href="https://www.tesselategroup.com" target="_blank" rel="noopener">Nicolo Zavarise — Tesselate</a></div>
  <div class="hero">
    <div class="container">
      <h1 class="h3 mb-1">ARR Interest Calculator</h1>
      <div class="subtitle">SONIA / SOFR — Compounded-in-Arrears with business-day lookback</div>
    </div>
  </div>

  <div class="container pb-4">
    <div class="row g-3">
      <div class="col-lg-6">
        <div class="calc-card p-3">
          <h3 class="h5 mb-3">Inputs</h3>

          <div class="mb-2"></div>
          <label class="form-label">Data Source</label>
          <select id="data_source" class="form-select mb-2">
            <option value="sonia_auto" selected>SONIA daily rates</option>
            <option value="sofr_auto">SOFR daily rates</option>
            <option value="rates">Manual rates array</option>
            <option value="csv_upload">CSV upload</option>
            <option value="csv_url">CSV from URL</option>
          </select>

          <div id="rates_block" class="mb-2">
            <label class="form-label">Rates JSON array</label>
            <textarea id="rates_text" class="form-control" spellcheck="false" rows="8">[
  { "date": "2023-12-20", "rate": 5.12 },
  { "date": "2023-12-21", "rate": 5.12 },
  { "date": "2023-12-22", "rate": 5.12 },
  { "date": "2023-12-27", "rate": 5.12 },
  { "date": "2023-12-28", "rate": 5.12 },
  { "date": "2023-12-29", "rate": 5.12 },
  { "date": "2024-01-02", "rate": 5.12 }
]</textarea>
          </div>

          <div id="csv_upload_block" class="mb-2" style="display:none">
            <label class="form-label">Upload CSV file</label>
            <input id="csv_file" type="file" accept=".csv,text/csv" class="form-control" />
            <div class="form-text">First column: YYYY-MM-DD, Second column: rate (percent or decimal). Header optional.</div>
          </div>

          <div id="csv_url_block" class="mb-2" style="display:none">
            <label class="form-label">CSV URL</label>
            <input id="csv_url" type="url" placeholder="https://..." class="form-control" />
          </div>

          <div class="mt-3 mb-2"></div>
          <div class="row g-2">
            <div class="col-md-4">
              <label class="form-label">Principal</label>
              <input id="principal" type="text" inputmode="decimal" value="1,000,000" class="form-control" placeholder="e.g., 1,000,000" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Start date</label>
              <input id="start_date" type="date" value="2024-01-01" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">End date</label>
              <input id="end_date" type="date" value="2024-04-01" class="form-control" />
            </div>
          </div>

          <div class="mt-3 mb-2"></div>
          <div class="row g-2 mt-1">
            <div class="col-md-4">
              <label class="form-label">Pricing option</label>
              <select id="pricing_option" class="form-select"><option>SONIA</option><option>SOFR</option></select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Lookback</label>
              <input id="lookback" type="number" min="1" step="1" value="5" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">CAS (% p.a.)</label>
              <input id="cas" type="number" step="0.0001" value="0.10" class="form-control" />
            </div>
          </div>

          <div class="row g-2 mt-1">
            <div class="col-md-4">
              <label class="form-label">Margin (% p.a.)</label>
              <input id="margin" type="number" step="0.0001" value="2.00" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Margin change date</label>
              <input id="margin_change_date" type="date" class="form-control" />
            </div>
            <div class="col-md-4">
              <label class="form-label">New margin (% p.a.)</label>
              <input id="margin_after" type="number" step="0.0001" placeholder="leave empty" class="form-control" />
            </div>
          </div>

          <div class="d-flex gap-2 mt-3 align-items-center">
            <button class="btn btn-primary" id="btn_calc">Calculate Interest</button>
            <button class="btn btn-outline-primary" id="btn_export_json">Export Results (JSON)</button>
            <button class="btn btn-outline-primary" id="btn_export_csv">Export Detail (CSV)</button>
            <span id="status" class="ms-2 text-secondary small"></span>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="calc-card p-3">
          <h3 class="h5 mb-2">Results</h3>
          <div id="results" class="row g-3"></div>
        </div>
      </div>
    </div>

    <div class="calc-card p-3 mt-3">
      <h3 class="h5 mb-2">Calculation Detail</h3>
      <div class="table-wrap">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Date</th>
              <th>Business Day</th>
              <th>Observation Date</th>
              <th>Daily Rate (%)</th>
              <th>Margin Rate (%)</th>
              <th>CAS Rate (%)</th>
              <th>Daily ARR Interest</th>
              <th>Daily Margin Interest</th>
              <th>Daily CAS Interest</th>
              <th>Cumulative Factor</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="detail_body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Constants for provided daily rate sources (Google Drive)
    const SONIA_CSV_URL = 'https://drive.google.com/uc?export=download&id=1oKqCUHzSOFD47SevIzrLbe6mOcw8L52C';
    const SOFR_CSV_URL  = 'https://drive.google.com/uc?export=download&id=1_5NwX-UJfXkR8cod3d_pfdoajAyKJZ8z';

    const dataSourceEl = document.getElementById('data_source');
    const ratesBlock = document.getElementById('rates_block');
    const csvUploadBlock = document.getElementById('csv_upload_block');
    const csvUrlBlock = document.getElementById('csv_url_block');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const detailBody = document.getElementById('detail_body');
    let lastPayload = null;
    let lastResult = null;

    function updateDataSourceUI() {
      const v = dataSourceEl.value;
      ratesBlock.style.display = v === 'rates' ? '' : 'none';
      csvUploadBlock.style.display = v === 'csv_upload' ? '' : 'none';
      csvUrlBlock.style.display = v === 'csv_url' ? '' : 'none';
      if (v === 'sonia_auto') {
        document.getElementById('pricing_option').value = 'SONIA';
      } else if (v === 'sofr_auto') {
        document.getElementById('pricing_option').value = 'SOFR';
      }
    }

    dataSourceEl.addEventListener('change', updateDataSourceUI);
    // Initialize on first load to reflect default selection
    updateDataSourceUI();

    document.getElementById('btn_calc').addEventListener('click', async () => {
      statusEl.textContent = 'Calculating...';
      resultsEl.textContent = '';
      detailBody.innerHTML = '';

      try {
        const payload = buildPayload();
        payload.return_daily_details = true; // always request details
        const resp = await fetch('/api/calc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || resp.statusText);

        lastPayload = payload;
        lastResult = data;

        const currency = (payload.pricing_option || 'SONIA').toUpperCase() === 'SONIA' ? 'GBP' : 'USD';
        renderResultsSummary(payload, data, currency);

        renderDetailTable(payload, data, currency);
        statusEl.textContent = 'Done';
      } catch (e) {
        statusEl.textContent = '';
        resultsEl.textContent = 'Error: ' + (e.message || String(e));
      }
    });

    document.getElementById('btn_export_json').addEventListener('click', () => {
      if (!lastResult) return;
      const blob = new Blob([JSON.stringify({ payload: lastPayload, result: lastResult }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `arr_results_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('btn_export_csv').addEventListener('click', () => {
      if (!lastResult || !Array.isArray(lastResult.daily_details)) return;
      const { rows } = buildDetailRows(lastPayload, lastResult);
      const header = ['Date','Business Day','Observation Date','Daily Rate (%)','Margin Rate (%)','CAS Rate (%)','Daily ARR Interest','Daily Margin Interest','Daily CAS Interest','Cumulative Factor','Day Type'];
      const csv = [header.join(','), ...rows.map(r => r.map(escapeCsv).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `arr_detail_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function buildPayload() {
      const principal = parseNumber(document.getElementById('principal').value);
      const start_date = document.getElementById('start_date').value;
      const end_date = document.getElementById('end_date').value;
      const pricing_option = document.getElementById('pricing_option').value;
      const lookback = Number(document.getElementById('lookback').value);
      const margin = getMaybeNumber('margin');
      const cas = getMaybeNumber('cas');
      const margin_change_date = document.getElementById('margin_change_date').value || undefined;
      const margin_after = getMaybeNumber('margin_after');

      const payload = { principal, start_date, end_date, pricing_option, lookback, margin, cas, margin_change_date, margin_after };

      const src = dataSourceEl.value;
      if (src === 'rates') {
        try {
          payload.rates = JSON.parse(document.getElementById('rates_text').value);
        } catch (e) {
          throw new Error('Invalid rates JSON array');
        }
      } else if (src === 'csv_url') {
        payload.csv_url = document.getElementById('csv_url').value;
      } else if (src === 'sonia_auto') {
        payload.csv_url = SONIA_CSV_URL;
        payload.pricing_option = 'SONIA';
      } else if (src === 'sofr_auto') {
        payload.csv_url = SOFR_CSV_URL;
        payload.pricing_option = 'SOFR';
      } else if (src === 'csv_upload') {
        const file = document.getElementById('csv_file').files[0];
        if (!file) throw new Error('Please choose a CSV file');
        payload.csv_text = window.__csvCache || '';
        if (!payload.csv_text) throw new Error('CSV file not loaded yet');
      }

      return payload;
    }

    function getMaybeNumber(id) {
      const raw = document.getElementById(id).value;
      return raw === '' ? undefined : Number(raw);
    }

    document.getElementById('csv_file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      window.__csvCache = text;
    });

    // Principal formatting (thousands separators)
    const principalEl = document.getElementById('principal');
    principalEl.addEventListener('blur', () => {
      const n = parseNumber(principalEl.value);
      if (!isNaN(n)) principalEl.value = n.toLocaleString(undefined, { maximumFractionDigits: 2 });
    });

    function parseNumber(s) {
      if (s === undefined || s === null) return NaN;
      const cleaned = String(s).replace(/,/g, '').trim();
      const n = Number(cleaned);
      return n;
    }

    function renderResultsSummary(payload, data, currency) {
      const items = [
        data.rates_last_date ? { label: 'Daily rates updated as of', value: data.rates_last_date } : null,
        { label: 'Compounded Factor (RFR)', value: Number(data.compounded_factor).toFixed(8) },
        { label: 'RFR Annualized Rate', value: (Number(data.rfr_annualized) * 100).toFixed(6) + '%' },
        { label: 'Applicable Annualized Rate', value: (Number(data.applicable_annualized_rate) * 100).toFixed(6) + '%' },
        { label: 'Interest (RFR)', value: currency + ' ' + Number(data.interest_rfr).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) },
        { label: 'Interest (Margin)', value: currency + ' ' + Number(data.interest_margin).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) },
        { label: 'Interest (CAS)', value: currency + ' ' + Number(data.interest_cas).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) },
        { label: 'TOTAL INTEREST', value: currency + ' ' + Number(data.interest_total).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) }
      ].filter(Boolean);

      const col = (arr) => arr.map(it => `
        <div class="col-12">
          <div class="d-flex justify-content-between border rounded px-2 py-1" style="border-color: var(--card-border)">
            <span class="text-secondary">${it.label}</span>
            <span class="fw-semibold">${it.value}</span>
          </div>
        </div>`).join('');

      resultsEl.innerHTML = col(items);
    }

    function renderDetailTable(payload, data, currency) {
      detailBody.innerHTML = '';
      if (!Array.isArray(data.daily_details)) return;
      const { rows } = buildDetailRows(payload, data);
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (const cell of r) {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      detailBody.appendChild(frag);
    }

    function buildDetailRows(payload, data) {
      const currency = (payload.pricing_option || 'SONIA').toUpperCase() === 'SONIA' ? 'GBP' : 'USD';
      const N = Number(data.N || (payload.pricing_option.toUpperCase() === 'SONIA' ? 365 : 360));
      const principal = Number(payload.principal);
      const margin_pa = toDecimal(payload.margin);
      const cas_pa = toDecimal(payload.cas);
      const eff = payload.margin_change_date ? payload.margin_change_date : null;
      const margin_after = payload.margin_after !== undefined && payload.margin_after !== null && payload.margin_after !== '' ? toDecimal(payload.margin_after) : margin_pa;

      const rows = [];
      let prevC = 1;
      for (const d of data.daily_details) {
        const dayType = d.is_business_day ? 'Business' : 'Non-Business';
        const currentC = Number(d.cumulative_factor);
        let dailyArr = (currentC - prevC) * principal;
        if (!d.is_business_day) dailyArr = 0;

        const useMargin = eff && d.date >= eff ? margin_after : margin_pa;
        const dailyMargin = (Number(useMargin) / N) * principal;
        const dailyCas = (Number(cas_pa) / N) * principal;

        const row = [
          d.date,
          d.business_day,
          d.observation_date,
          (Number(d.daily_rate) * 100).toFixed(6),
          (Number(useMargin) * 100).toFixed(6),
          (Number(cas_pa) * 100).toFixed(6),
          currency + ' ' + formatMoney(dailyArr),
          currency + ' ' + formatMoney(dailyMargin),
          currency + ' ' + formatMoney(dailyCas),
          Number(d.cumulative_factor).toFixed(8),
          dayType
        ];
        rows.push(row);
        prevC = currentC;
      }
      return { rows, currency };
    }

    function toDecimal(x) {
      if (x === undefined || x === null || x === '') return 0;
      const v = Number(x);
      return v > 1 ? v/100 : v;
    }

    function formatMoney(n) {
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeCsv(s) {
      const str = String(s);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <footer class="py-3 mt-4 border-top">
    <div class="container text-center text-muted small">
      © 2025 Nicolo Zavarise — <a href="https://www.tesselategroup.com" target="_blank" rel="noopener" class="text-decoration-none">Tesselate</a>. This tool is provided “as is” for informational purposes only and does not constitute financial advice.
    </div>
  </footer>
</body>
</html>
