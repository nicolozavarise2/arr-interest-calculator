<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ARR Interest Calculator</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: #0f172a;
      --muted: #94a3b8;
      --text: #e2e8f0;
      --accent: #22c55e;
      --border: #1f2a44;
    }
    html, body { height: 100%; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    .container { max-width: 1100px; margin: 0 auto; padding: 2rem 1rem 4rem; }
    h1 { margin: 0 0 0.25rem; font-size: 2rem; }
    .subtitle { color: var(--muted); margin-bottom: 1.5rem; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1rem; }
    label { display: block; margin: 0.5rem 0 0.25rem; font-size: 0.9rem; color: var(--muted); }
    input, select, textarea { width: 100%; box-sizing: border-box; background: #0b132b; color: var(--text); border: 1px solid var(--border); border-radius: 8px; padding: 0.55rem 0.65rem; }
    textarea { height: 200px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; }
    .actions { display: flex; gap: 0.75rem; margin-top: 1rem; }
    button { padding: 0.6rem 1rem; border-radius: 8px; border: 1px solid var(--border); background: #0b132b; color: var(--text); cursor: pointer; }
    button.primary { background: var(--accent); color: #052e1b; border: none; font-weight: 600; }
    .muted { color: var(--muted); }
    pre { white-space: pre-wrap; word-break: break-word; background: #0a0f1f; color: #d1d5db; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border); max-height: 400px; overflow: auto; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .hint { font-size: 0.85rem; color: var(--muted); }
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th, td { border-bottom: 1px solid var(--border); padding: 0.5rem; text-align: left; }
    thead th { position: sticky; top: 0; background: #0a0f1f; z-index: 1; }
    .table-wrap { max-height: 500px; overflow: auto; border: 1px solid var(--border); border-radius: 8px; }
    .brand-badge { position: fixed; top: 10px; right: 12px; background: #0a0f1f; border: 1px solid var(--border); color: var(--muted); padding: 6px 10px; border-radius: 8px; font-size: 12px; }
  </style>
</head>
<body>
  <div class="brand-badge">Nicolo Zavarise — Tesselate</div>
  <div class="container">
    <h1>ARR Interest Calculator</h1>
    <div class="subtitle">SONIA / SOFR — Compounded-in-Arrears with business-day lookback</div>

    <div class="grid">
      <div class="card">
        <h3>Inputs</h3>
        <label>Data Source</label>
        <select id="data_source">
          <option value="rates">Manual rates array</option>
          <option value="csv_upload">CSV upload</option>
          <option value="csv_url">CSV from URL</option>
          <option value="sonia_auto">SONIA daily rates</option>
          <option value="sofr_auto">SOFR daily rates</option>
        </select>

        <div id="rates_block">
          <label>Rates JSON array</label>
          <textarea id="rates_text" spellcheck="false">[
  { "date": "2023-12-20", "rate": 5.12 },
  { "date": "2023-12-21", "rate": 5.12 },
  { "date": "2023-12-22", "rate": 5.12 },
  { "date": "2023-12-27", "rate": 5.12 },
  { "date": "2023-12-28", "rate": 5.12 },
  { "date": "2023-12-29", "rate": 5.12 },
  { "date": "2024-01-02", "rate": 5.12 }
]</textarea>
        </div>

        <div id="csv_upload_block" style="display:none">
          <label>Upload CSV file</label>
          <input id="csv_file" type="file" accept=".csv,text/csv" />
          <div class="hint">First column: YYYY-MM-DD, Second column: rate (percent or decimal). Header optional.</div>
        </div>

        <div id="csv_url_block" style="display:none">
          <label>CSV URL</label>
          <input id="csv_url" type="url" placeholder="https://..." />
        </div>

        <div class="row">
          <div>
            <label>Principal</label>
            <input id="principal" type="number" step="0.01" value="1000000" />
          </div>
          <div>
            <label>Start date</label>
            <input id="start_date" type="date" value="2024-01-01" />
          </div>
          <div>
            <label>End date</label>
            <input id="end_date" type="date" value="2024-04-01" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Pricing option</label>
            <select id="pricing_option"><option>SONIA</option><option>SOFR</option></select>
          </div>
          <div>
            <label>Lookback (business days)</label>
            <input id="lookback" type="number" min="1" step="1" value="5" />
          </div>
          <div>
            <label>CAS (% p.a.)</label>
            <input id="cas" type="number" step="0.0001" value="0.10" />
          </div>
        </div>

        <div class="row">
          <div>
            <label>Margin (% p.a.)</label>
            <input id="margin" type="number" step="0.0001" value="2.00" />
          </div>
          <div>
            <label>Margin change date</label>
            <input id="margin_change_date" type="date" />
          </div>
          <div>
            <label>New margin (% p.a.)</label>
            <input id="margin_after" type="number" step="0.0001" placeholder="leave empty" />
          </div>
        </div>

        <div class="actions">
          <button class="primary" id="btn_calc">Calculate Interest</button>
          <button id="btn_export_json">Export Results (JSON)</button>
          <button id="btn_export_csv">Export Detail (CSV)</button>
          <span id="status" class="muted"></span>
        </div>
      </div>

      <div class="card">
        <h3>Results</h3>
        <pre id="results"></pre>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h3>Calculation Detail</h3>
      <div class="table-wrap">
        <table id="detail_table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Business Day</th>
              <th>Observation Date</th>
              <th>Daily Rate (%)</th>
              <th>Margin Rate (%)</th>
              <th>CAS Rate (%)</th>
              <th>Daily ARR Interest</th>
              <th>Daily Margin Interest</th>
              <th>Daily CAS Interest</th>
              <th>Cumulative Factor</th>
              <th>Type</th>
            </tr>
          </thead>
          <tbody id="detail_body"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Constants for provided daily rate sources (Google Drive)
    const SONIA_CSV_URL = 'https://drive.google.com/uc?export=download&id=1oKqCUHzSOFD47SevIzrLbe6mOcw8L52C';
    const SOFR_CSV_URL  = 'https://drive.google.com/uc?export=download&id=1oKqCUHzSOFD47SevIzrLbe6mOcw8L52C';

    const dataSourceEl = document.getElementById('data_source');
    const ratesBlock = document.getElementById('rates_block');
    const csvUploadBlock = document.getElementById('csv_upload_block');
    const csvUrlBlock = document.getElementById('csv_url_block');
    const statusEl = document.getElementById('status');
    const resultsEl = document.getElementById('results');
    const detailBody = document.getElementById('detail_body');
    let lastPayload = null;
    let lastResult = null;

    dataSourceEl.addEventListener('change', () => {
      const v = dataSourceEl.value;
      ratesBlock.style.display = v === 'rates' ? '' : 'none';
      csvUploadBlock.style.display = v === 'csv_upload' ? '' : 'none';
      csvUrlBlock.style.display = v === 'csv_url' ? '' : 'none';
      // If auto sources selected, set pricing option and hide URL block
      if (v === 'sonia_auto') {
        document.getElementById('pricing_option').value = 'SONIA';
      } else if (v === 'sofr_auto') {
        document.getElementById('pricing_option').value = 'SOFR';
      }
    });

    document.getElementById('btn_calc').addEventListener('click', async () => {
      statusEl.textContent = 'Calculating...';
      resultsEl.textContent = '';
      detailBody.innerHTML = '';

      try {
        const payload = buildPayload();
        payload.return_daily_details = true; // always request details like Tkinter tab
        const resp = await fetch('/api/calc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await resp.json();
        if (!resp.ok) throw new Error(data.error || resp.statusText);

        lastPayload = payload;
        lastResult = data;

        const currency = (payload.pricing_option || 'SONIA').toUpperCase() === 'SONIA' ? 'GBP' : 'USD';
        const resText = [
          `Compounded Factor (RFR): ${Number(data.compounded_factor).toFixed(8)}`,
          `RFR Annualized Rate: ${(Number(data.rfr_annualized) * 100).toFixed(6)}%`,
          `Applicable Annualized Rate: ${(Number(data.applicable_annualized_rate) * 100).toFixed(6)}%`,
          `Interest (RFR): ${currency} ${Number(data.interest_rfr).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`,
          `Interest (Margin): ${currency} ${Number(data.interest_margin).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`,
          `Interest (CAS): ${currency} ${Number(data.interest_cas).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`,
          `TOTAL INTEREST: ${currency} ${Number(data.interest_total).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}`
        ].join('\n');
        resultsEl.textContent = resText;

        renderDetailTable(payload, data, currency);

        statusEl.textContent = 'Done';
      } catch (e) {
        statusEl.textContent = '';
        resultsEl.textContent = 'Error: ' + (e.message || String(e));
      }
    });

    document.getElementById('btn_export_json').addEventListener('click', () => {
      if (!lastResult) return;
      const blob = new Blob([JSON.stringify({ payload: lastPayload, result: lastResult }, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `arr_results_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('btn_export_csv').addEventListener('click', () => {
      if (!lastResult || !Array.isArray(lastResult.daily_details)) return;
      const { rows, currency } = buildDetailRows(lastPayload, lastResult);
      const header = ['Date','Business Day','Observation Date','Daily Rate (%)','Margin Rate (%)','CAS Rate (%)','Daily ARR Interest','Daily Margin Interest','Daily CAS Interest','Cumulative Factor','Day Type'];
      const csv = [header.join(','), ...rows.map(r => r.map(escapeCsv).join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `arr_detail_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    });

    function buildPayload() {
      const principal = Number(document.getElementById('principal').value);
      const start_date = document.getElementById('start_date').value;
      const end_date = document.getElementById('end_date').value;
      const pricing_option = document.getElementById('pricing_option').value;
      const lookback = Number(document.getElementById('lookback').value);
      const margin = getMaybeNumber('margin');
      const cas = getMaybeNumber('cas');
      const margin_change_date = document.getElementById('margin_change_date').value || undefined;
      const margin_after = getMaybeNumber('margin_after');

      const payload = { principal, start_date, end_date, pricing_option, lookback, margin, cas, margin_change_date, margin_after };

      const src = dataSourceEl.value;
      if (src === 'rates') {
        try {
          payload.rates = JSON.parse(document.getElementById('rates_text').value);
        } catch (e) {
          throw new Error('Invalid rates JSON array');
        }
      } else if (src === 'csv_url') {
        payload.csv_url = document.getElementById('csv_url').value;
      } else if (src === 'sonia_auto') {
        payload.csv_url = SONIA_CSV_URL;
        payload.pricing_option = 'SONIA';
      } else if (src === 'sofr_auto') {
        payload.csv_url = SOFR_CSV_URL;
        payload.pricing_option = 'SOFR';
      } else if (src === 'csv_upload') {
        const file = document.getElementById('csv_file').files[0];
        if (!file) throw new Error('Please choose a CSV file');
        payload.csv_text = window.__csvCache || '';
        if (!payload.csv_text) throw new Error('CSV file not loaded yet');
      }

      return payload;
    }

    function getMaybeNumber(id) {
      const raw = document.getElementById(id).value;
      return raw === '' ? undefined : Number(raw);
    }

    // Load CSV file content into memory when selected
    document.getElementById('csv_file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      window.__csvCache = text;
    });

    function renderDetailTable(payload, data, currency) {
      detailBody.innerHTML = '';
      if (!Array.isArray(data.daily_details)) return;
      const { rows } = buildDetailRows(payload, data);
      const frag = document.createDocumentFragment();
      for (const r of rows) {
        const tr = document.createElement('tr');
        for (const cell of r) {
          const td = document.createElement('td');
          td.textContent = cell;
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }
      detailBody.appendChild(frag);
    }

    function buildDetailRows(payload, data) {
      const currency = (payload.pricing_option || 'SONIA').toUpperCase() === 'SONIA' ? 'GBP' : 'USD';
      const N = Number(data.N || (payload.pricing_option.toUpperCase() === 'SONIA' ? 365 : 360));
      const principal = Number(payload.principal);
      const margin_pa = toDecimal(payload.margin); // e.g. 2.0 -> 0.02
      const cas_pa = toDecimal(payload.cas);
      const eff = payload.margin_change_date ? payload.margin_change_date : null;
      const margin_after = payload.margin_after !== undefined && payload.margin_after !== null && payload.margin_after !== '' ? toDecimal(payload.margin_after) : margin_pa;

      const rows = [];
      let prevC = 1; // previous cumulative factor
      for (const d of data.daily_details) {
        const dayType = d.is_business_day ? 'Business' : 'Non-Business';
        const currentC = Number(d.cumulative_factor);
        let dailyArr = (currentC - prevC) * principal;
        if (!d.is_business_day) dailyArr = 0;

        // margin applicable for this calendar day
        const useMargin = eff && d.date >= eff ? margin_after : margin_pa;
        const dailyMargin = (Number(useMargin) / N) * principal;
        const dailyCas = (Number(cas_pa) / N) * principal;

        const row = [
          d.date,
          d.business_day,
          d.observation_date,
          (Number(d.daily_rate) * 100).toFixed(6),
          (Number(useMargin) * 100).toFixed(6),
          (Number(cas_pa) * 100).toFixed(6),
          currency + ' ' + formatMoney(dailyArr),
          currency + ' ' + formatMoney(dailyMargin),
          currency + ' ' + formatMoney(dailyCas),
          Number(d.cumulative_factor).toFixed(8),
          dayType
        ];
        rows.push(row);
        prevC = currentC;
      }
      return { rows, currency };
    }

    function toDecimal(x) {
      if (x === undefined || x === null || x === '') return 0;
      const v = Number(x);
      return v > 1 ? v/100 : v;
    }

    function formatMoney(n) {
      return Number(n).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function escapeCsv(s) {
      const str = String(s);
      if (str.includes(',') || str.includes('"') || str.includes('\n')) {
        return '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }
  </script>
</body>
</html>
